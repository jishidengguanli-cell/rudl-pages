<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>Recharge</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;margin:0;padding:24px;background:#fafafa;color:#222}
    .wrap{max-width:960px;margin:0 auto}
    .bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:16px}
    .plans{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:12px}
    .card{background:#fff;border:1px solid #e5e5e5;border-radius:16px;padding:16px;box-shadow:0 1px 3px rgba(0,0,0,.04)}
    .price{font-size:28px;font-weight:700;margin:6px 0}
    .muted{color:#666;font-size:14px}
    button{border:1px solid #ddd;background:#fff;border-radius:12px;padding:10px 14px;cursor:pointer}
    button:hover{background:#f7f7f7}
    .stack{display:flex;gap:8px;flex-wrap:wrap;margin-top:16px}
    .notice{margin-top:18px;color:#666;font-size:14px}
    .hr{height:1px;background:#eee;margin:20px 0}
  </style>
</head>
<body>
  <div class="wrap">
    <div class="bar">
      <h1>Recharge</h1>
      <div>Balance: <b id="balance">0</b> pts</div>
    </div>

    <div class="plans" id="plans"></div>

    <div class="hr"></div>

    <p class="notice">
      Downloads cost 3 pts (Android) and 5 pts (iOS). You can recharge any time.
    </p>
    <p>
      Currently only accepts crypto payments, e-wallet addresses:TEfWH9Z8vZMgz7YiT7xnzxs4UoNCTgeyoN
    </p>
  </div>

  <script>
    // --- 確保每個瀏覽器有一個 uid（存在 cookie） ---
    // (function ensureUid(){
    //   if (document.cookie.split('; ').some(v => v.startsWith('uid='))) return;
    //   const uid = (crypto.randomUUID ? crypto.randomUUID() : Math.random().toString(36).slice(2));
    //   document.cookie = `uid=${encodeURIComponent(uid)}; Path=/; Max-Age=${60*60*24*365}; SameSite=Lax`;
    // })();

    const elBal = document.querySelector('#balance');
    const elPlans = document.querySelector('#plans');

    async function getJSON(url, opts) {
      const r = await fetch(url, opts);
      const j = await r.json().catch(()=>({}));
      if (!r.ok) throw Object.assign(new Error(j.error || r.statusText), {status: r.status, data: j});
      return j;
    }

    async function loadPlans() {
      const { plans } = await getJSON('/api/plans');
      elPlans.innerHTML = '';
      for (const p of plans) {
        const el = document.createElement('div');
        el.className = 'card';
        el.innerHTML = `
          <div class="title" style="font-weight:600">${p.name}</div>
          <div class="price">$${(p.priceCents/100).toFixed(0)} <span class="muted">/ one-time</span></div>
          <div class="muted">Includes ${p.points} points</div>
          <div style="margin-top:12px"><button>Buy now</button></div>
        `;
        el.querySelector('button').addEventListener('click', () => buy(p.id));
        elPlans.appendChild(el);
      }
    }

    async function loadBalance() {
      const { points } = await getJSON('/api/me/points');
      elBal.textContent = points;
      // 廣播：同分頁事件 + 跨分頁 storage 事件
      window.dispatchEvent(new Event('points:updated'));
      localStorage.setItem('points:updated', String(Date.now()));
    }

    async function buy(planId) {
      try {
        const j = await getJSON('/api/orders', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ planId })
        });
        elBal.textContent = j.balance;
      } catch (e) {
        alert(e.message || 'Failed');
      }
      window.dispatchEvent(new Event('points:updated'));
      localStorage.setItem('points:updated', String(Date.now()));
    }

    async function deduct(platform) {
      try {
        const j = await getJSON('/api/points/deduct', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ platform })
        });
        elBal.textContent = j.balance;
      } catch (e) {
        if (e.status === 402) alert('Insufficient points');
        else alert(e.message || 'Failed');
      }
      window.dispatchEvent(new Event('points:updated'));
      localStorage.setItem('points:updated', String(Date.now()));
    }

    // init
    (async () => {
      await Promise.all([loadPlans(), loadBalance()]);
    })();
  </script>
</body>
</html>
