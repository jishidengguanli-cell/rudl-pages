<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>管理後台 - RU Download</title>
<link rel="icon" href="/favicon.ico">
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  header{background:#0b1222;border-bottom:1px solid #1f2937}
  .wrap{max-width:1200px;margin:0 auto;padding:16px}
  nav{display:flex;align-items:center;gap:12px}
  nav .right{margin-left:auto;display:flex;gap:10px}
  a{color:#93c5fd;text-decoration:none}
  .btn{padding:8px 12px;border-radius:10px;border:0;background:#3b82f6;color:#fff;cursor:pointer}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:16px;margin-top:16px}
  table{width:100%;border-collapse:separate;border-spacing:0 10px}
  th{position:sticky;top:0;background:#0f172a;padding:10px 12px;text-align:left;box-shadow: inset 0 -1px 0 #1f2937}
  td{background:#0b1220;padding:12px 12px;box-shadow: inset 0 -1px 0 #1f2937}
  td:first-child{border-radius:12px 0 0 12px} td:last-child{border-radius:0 12px 12px 0}
  .muted{color:#9ca3af}
</style>

<header>
  <div class="wrap">
    <nav>
      <strong>RU Download</strong>
      <div class="right">
        <a href="/dashboard.html">分發列表</a>
        <a href="#" id="logout">登出</a>
      </div>
    </nav>
  </div>
</header>

<main class="wrap">
  <h2 style="margin:10px 0">管理後台</h2>

  <div class="card">
    <h3 style="margin:0 0 8px">總覽</h3>
    <div class="muted" id="me">讀取中…</div>
    <div id="stats" style="margin-top:8px">載入中…</div>
  </div>

  <div class="card">
    <h3 style="margin:0 0 8px">使用者</h3>
    <table>
      <thead><tr><th>Email</th><th>UID</th><th>角色</th><th>建立時間</th><th>操作</th></tr></thead>
      <tbody id="users"></tbody>
    </table>
    <div style="margin-top:8px"><button class="btn" id="more">載入更多</button></div>
  </div>

  <div class="card">
  <h3 style="margin:0 0 8px">所有分發</h3>

  <div style="display:flex;gap:8px;align-items:center;margin:6px 0 10px">
    <input id="qLinks" placeholder="搜尋：code / owner / 檔名 / 平台" style="flex:1;min-width:240px">
    <label>排序：
      <select id="sortLinks">
        <option value="createdAt">建立時間</option>
        <option value="today">今日</option>
        <option value="total">累計</option>
      </select>
    </label>
    <label>方向：
      <select id="orderLinks">
        <option value="desc">降序</option>
        <option value="asc">升序</option>
      </select>
    </label>
    <button class="btn" id="refreshLinks">重新整理</button>
  </div>

  <table>
    <thead>
      <tr>
        <th><input type="checkbox" id="chkAll"></th>
        <th>Code</th><th>Owner</th><th>平台</th><th>檔名</th>
        <th>今日</th><th>累計</th><th>建立時間</th><th>操作</th>
      </tr>
    </thead>
    <tbody id="links"></tbody>
  </table>
  <div style="display:flex;justify-content:space-between;margin-top:8px">
    <button class="btn red" id="bulkDelete" disabled>刪除所選</button>
    <button class="btn" id="moreLinks">載入更多</button>
  </div>
</div>

</main>

<script>
const $ = (id)=>document.getElementById(id);
const fmt = (ts)=> ts ? new Date(ts).toLocaleString() : "-";

(async ()=>{
  // 顯示登入者（以及是否為管理員）
  const meR = await fetch('/api/auth/me', {credentials:'include'});
  const me = await meR.json();
  $('me').textContent = me?.email ? `目前登入：${me.email}` : '尚未登入';

  // 讀取總覽
  const sR = await fetch('/api/admin/stats', {credentials:'include'});
  if (!sR.ok){
    const next = encodeURIComponent('/admin.html');
    $('stats').innerHTML = '沒有權限或尚未登入。<a href="/login.html?next=' + next + '">去登入</a>';
    return;
  }
  const s = await sR.json();
  $('stats').innerHTML = `使用者：<b>${s.users}</b>　分發：<b>${s.links}</b>　更新時間：${fmt(s.ts)}`;

  // 列使用者（分頁）
  let cursor = undefined, loading = false;
  async function loadUsers(){
    if (loading) return; loading = true;
    const url = new URL('/api/admin/users/list', location.origin);
    if (cursor) url.searchParams.set('cursor', cursor);
    url.searchParams.set('limit','50');
    const r = await fetch(url, {credentials:'include'});
    if (!r.ok){ $('users').innerHTML = '<tr><td colspan="4">讀取失敗或無權限</td></tr>'; return; }
    const data = await r.json();
    for (const it of data.items){
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${it.email}</td><td>${it.uid||''}</td><td>${it.role||'user'}</td><td>${fmt(it.createdAt)}</td>`;
      $('users').appendChild(tr);
    }
    cursor = data.cursor || undefined;
    $('more').style.display = data.list_complete ? 'none' : 'inline-block';
    loading = false;
  }
  $('more').addEventListener('click', loadUsers);
  loadUsers();
})();


/* ====== 所有分發（搜尋/排序/分頁/批刪） ====== */
let cursorL = undefined, loadingL = false, selectedCodes = new Set();

function renderLinksRow(it){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td><input type="checkbox" data-code="${it.code}"></td>
    <td><a href="/d/${it.code}" target="_blank">${it.code}</a></td>
    <td>${it.owner || ''}</td>
    <td>${it.platform || ''}</td>
    <td>${it.filename || ''}</td>
    <td>${it.today || 0}</td>
    <td>${it.total || 0}</td>
    <td>${it.createdAt ? new Date(it.createdAt).toLocaleString() : '-'}</td>
    <td><button class="btn red" data-del="${it.code}">刪除</button></td>
  `;
  return tr;
}

async function loadAllLinks(reset=false){
  if (loadingL) return; loadingL = true;
  if (reset){ cursorL = undefined; document.getElementById('links').innerHTML=''; }
  const url = new URL('/api/admin/links/list-all', location.origin);
  if (cursorL) url.searchParams.set('cursor', cursorL);
  url.searchParams.set('limit', '50');
  url.searchParams.set('q', document.getElementById('qLinks').value.trim());
  url.searchParams.set('sort', document.getElementById('sortLinks').value);
  url.searchParams.set('order', document.getElementById('orderLinks').value);

  const r = await fetch(url, { credentials:'include' });
  if (!r.ok){ document.getElementById('links').innerHTML = '<tr><td colspan="9">讀取失敗或無權限</td></tr>'; loadingL=false; return; }
  const data = await r.json();

  for (const it of data.items) {
    const tr = renderLinksRow(it);
    document.getElementById('links').appendChild(tr);
  }
  cursorL = data.cursor || undefined;
  document.getElementById('moreLinks').style.display = data.list_complete ? 'none' : 'inline-block';
  bindLinkRowEvents();
  loadingL = false;
  updateBulkBtn();
}

function bindLinkRowEvents(){
  // 單筆刪除
  document.querySelectorAll('button[data-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const code = btn.getAttribute('data-del');
      if (!confirm(`刪除分發 ${code}？`)) return;
      btn.disabled = true; btn.textContent='刪除中…';
      await fetch('/api/admin/links/delete', {
        method:'POST', credentials:'include',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ code })
      });
      btn.closest('tr').remove();
      selectedCodes.delete(code);
      updateBulkBtn();
    }
  });
  // 勾選
  document.querySelectorAll('input[type=checkbox][data-code]').forEach(chk=>{
    chk.onchange = ()=>{
      const code = chk.getAttribute('data-code');
      if (chk.checked) selectedCodes.add(code); else selectedCodes.delete(code);
      updateBulkBtn();
    }
  });
}

function updateBulkBtn(){
  const bulk = document.getElementById('bulkDelete');
  bulk.disabled = selectedCodes.size === 0;
  document.getElementById('chkAll').checked =
    selectedCodes.size > 0 &&
    selectedCodes.size === document.querySelectorAll('input[type=checkbox][data-code]').length;
}

document.getElementById('qLinks').addEventListener('keydown', e=>{
  if (e.key === 'Enter') loadAllLinks(true);
});
document.getElementById('sortLinks').onchange = ()=> loadAllLinks(true);
document.getElementById('orderLinks').onchange = ()=> loadAllLinks(true);
document.getElementById('refreshLinks').onclick = ()=> loadAllLinks(true);
document.getElementById('moreLinks').onclick = ()=> loadAllLinks(false);

document.getElementById('chkAll').onchange = (e)=>{
  const all = document.querySelectorAll('input[type=checkbox][data-code]');
  selectedCodes.clear();
  all.forEach(chk=>{ chk.checked = e.target.checked; if (chk.checked) selectedCodes.add(chk.getAttribute('data-code')); });
  updateBulkBtn();
};
document.getElementById('bulkDelete').onclick = async ()=>{
  if (selectedCodes.size === 0) return;
  if (!confirm(`確定刪除 ${selectedCodes.size} 個分發？`)) return;
  const codes = Array.from(selectedCodes);
  await fetch('/api/admin/links/delete', {
    method:'POST', credentials:'include',
    headers:{'content-type':'application/json'},
    body: JSON.stringify({ codes })
  });
  // 從畫面移除
  document.querySelectorAll('input[type=checkbox][data-code]').forEach(chk=>{
    const code = chk.getAttribute('data-code');
    if (selectedCodes.has(code)) chk.closest('tr')?.remove();
  });
  selectedCodes.clear();
  updateBulkBtn();
};

loadAllLinks(true);

/* ====== 使用者管理 操作鈕 ====== */
function renderUserRow(u){
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td>${u.email || '-'}</td>
    <td>${u.uid}</td>
    <td>${u.role}</td>
    <td>${u.createdAt ? new Date(u.createdAt).toLocaleString() : '-'}</td>
    <td style="white-space:nowrap;display:flex;gap:6px">
      <button class="btn" data-role="${u.uid}|${u.role==='admin'?'user':'admin'}">
        ${u.role==='admin'?'降為一般':'升為管理員'}
      </button>
      <button class="btn" data-reset="${u.uid}">重設密碼</button>
      <button class="btn red" data-u-del="${u.uid}">刪除</button>
    </td>
  `;
  return tr;
}

async function loadUsers(reset=false){
  // 你原本的 fetch users 程式…
  // 取得 data.items 後：
  const tbody = document.getElementById('users'); // 你的 <tbody id="users">
  if (reset) tbody.innerHTML = '';
  for (const u of data.items){
    tbody.appendChild(renderUserRow(u));
  }
  bindUserRowEvents();
}

function bindUserRowEvents(){
  // 升/降權
  document.querySelectorAll('button[data-role]').forEach(btn=>{
    btn.onclick = async ()=>{
      const [uid, role] = btn.getAttribute('data-role').split('|');
      btn.disabled = true; btn.textContent = '處理中…';
      await fetch('/api/admin/users/role', {
        method:'POST', credentials:'include',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ uid, role })
      });
      location.reload();
    }
  });
  // 重設密碼
  document.querySelectorAll('button[data-reset]').forEach(btn=>{
    btn.onclick = async ()=>{
      const uid = btn.getAttribute('data-reset');
      const pw = prompt('請輸入新的密碼（至少 8 碼）：');
      if (!pw) return;
      if (pw.length < 8) return alert('密碼至少 8 碼');
      btn.disabled = true; btn.textContent = '重設中…';
      const r = await fetch('/api/admin/users/reset-password', {
        method:'POST', credentials:'include',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ uid, newPassword: pw })
      });
      if (!r.ok) alert('重設失敗');
      else alert('已重設密碼');
      btn.disabled = false; btn.textContent = '重設密碼';
    }
  });
  // 刪除使用者
  document.querySelectorAll('button[data-u-del]').forEach(btn=>{
    btn.onclick = async ()=>{
      const uid = btn.getAttribute('data-u-del');
      if (!confirm('確定刪除這個使用者？（可在後端開啟 cascade 參數一併刪分發）')) return;
      btn.disabled = true; btn.textContent = '刪除中…';
      const r = await fetch('/api/admin/users/delete', {
        method:'POST', credentials:'include',
        headers:{'content-type':'application/json'},
        body: JSON.stringify({ uid, cascade: false })
      });
      if (r.ok) btn.closest('tr').remove();
      else alert('刪除失敗');
    }
  });
}

  
$('logout').addEventListener('click', async (e)=>{
  e.preventDefault();
  try{ await fetch('/api/auth/logout', {method:'POST', credentials:'include'}); }catch{}
  location.href = '/login.html';
});
</script>
