<!doctype html>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>註冊 - RU Download</title>
<style>
  body{margin:0;background:#0f172a;color:#e5e7eb;font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
  .wrap{max-width:420px;margin:60px auto;padding:0 16px}
  .card{background:#111827;border:1px solid #1f2937;border-radius:16px;padding:24px}
  label{display:block;margin:10px 0 4px;color:#9ca3af}
  input{width:100%;padding:10px 12px;border-radius:10px;border:1px solid #334155;background:#0b1222;color:#e5e7eb}
  button{width:100%;padding:12px;border-radius:10px;border:0;background:#10b981;color:#0b1222;margin-top:16px;font-weight:700;cursor:pointer}
  a{color:#93c5fd;text-decoration:none}
  .err{color:#fca5a5;margin-top:8px;min-height:20px;white-space:pre-wrap}
</style>

<div class="wrap">
  <div class="card">
    <h2 style="margin-top:0">建立帳號</h2>
    <label>Email</label>
    <input id="email" type="email" placeholder="you@example.com" />
    <label>密碼</label>
    <input id="pw" type="password" placeholder="至少 8 碼" />
    <div class="err" id="err"></div>
    <button id="btn">註冊</button>
    <p style="text-align:center;margin:12px 0 0">已有帳號？<a href="/login.html">去登入</a></p>
  </div>
</div>

<script>
const $ = id => document.getElementById(id);
$("pw").addEventListener("keydown", e => { if (e.key === "Enter") $("btn").click(); });

$("btn").addEventListener("click", async () => {
  const email = $("email").value.trim();
  const password = $("pw").value;
  const err = $("err"); err.textContent = "";

  if (!/^[^@]+@[^@]+\.[^@]+$/.test(email)) return err.textContent = "請輸入正確的 Email";
  if (password.length < 8) return err.textContent = "密碼至少 8 碼";

  $("btn").disabled = true; $("btn").textContent = "建立中…";
  try {
    const r = await fetch("/api/auth/register", {
      method: "POST",
      credentials: "include",
      headers: { "content-type": "application/json" },
      body: JSON.stringify({ email, password })
    });
    const data = await r.json().catch(() => ({}));
    if (!r.ok) {
      if (r.status === 409 || data?.error === "email already registered") {
        err.textContent = "此 Email 已被註冊";
      } else {
        err.textContent = data?.error || "註冊失敗，請稍後再試";
      }
      return;
    }
    // 二次確認 Cookie 是否生效
    const me = await fetch("/api/auth/me", { credentials: "include" }).then(x=>x.json());
    if (!me.authenticated) {
      err.textContent = "登入狀態確認失敗，請重新整理或再試一次。";
      return;
    }
    location.href = "/dashboard.html";
  } catch (e) {
    err.textContent = String(e);
  } finally {
    $("btn").disabled = false; $("btn").textContent = "註冊";
  }
});
</script>
